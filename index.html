<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LocalNVR</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%231a1a1a' width='100' height='100'/%3E%3Cpath fill='%234a9eff' d='M20 25h60v50H20z'/%3E%3Ccircle fill='%23ff4444' cx='50' cy='50' r='8'/%3E%3Cpath fill='none' stroke='%234a9eff' stroke-width='3' d='M30 35l40 30M70 35L30 65'/%3E%3C/svg%3E">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    #controls {
      padding: 12px 20px;
      background: linear-gradient(to bottom, #1a1a1a, #151515);
      display: flex;
      gap: 12px;
      align-items: center;
      border-bottom: 1px solid #2a2a2a;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      flex-wrap: wrap;
    }
    
    select, input {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #2a2a2a;
      color: #e0e0e0;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    select:hover, input:hover { border-color: #4a9eff; background: #2f2f2f; }
    select:focus, input:focus { outline: none; border-color: #4a9eff; box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2); }
    
    button {
      padding: 8px 16px;
      background: linear-gradient(to bottom, #4a9eff, #2563eb);
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    button:hover { background: linear-gradient(to bottom, #5aa8ff, #3573fb); transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    #videoInfo {
      margin-left: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #4a9eff;
      display: flex;
      gap: 20px;
    }
    
    #videoContainer {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }
    
    video {
      max-width: 100%;
      max-height: 100%;
      box-shadow: 0 0 30px rgba(0,0,0,0.8);
    }
    

    
    #playbackControls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      padding: 12px 20px;
      border-radius: 30px;
      display: flex;
      gap: 15px;
      align-items: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .control-btn {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s;
      box-shadow: none;
      font-size: 16px;
    }
    
    .control-btn:hover { background: rgba(74, 158, 255, 0.3); transform: scale(1.1); }
    
    #speedIndicator {
      font-size: 12px;
      color: #4a9eff;
      min-width: 40px;
      text-align: center;
      font-weight: bold;
    }
    
    #timeline {
      height: 120px;
      background: #1a1a1a;
      position: relative;
      border-top: 2px solid #2a2a2a;
    }
    
    #timelineWrapper {
      overflow-x: auto;
      overflow-y: hidden;
      height: 100%;
      cursor: grab;
      scrollbar-width: thin;
      scrollbar-color: #4a9eff #1a1a1a;
    }
    
    #timelineWrapper::-webkit-scrollbar { height: 8px; }
    #timelineWrapper::-webkit-scrollbar-track { background: #1a1a1a; }
    #timelineWrapper::-webkit-scrollbar-thumb { background: #4a9eff; border-radius: 4px; }
    
    #timelineWrapper.grabbing { cursor: grabbing; }
    
    #timelineBar {
      height: 80px;
      background: linear-gradient(to bottom, #2a2a2a, #1f1f1f);
      margin: 20px 10px 10px;
      position: relative;
      min-width: 100%;
      border-radius: 8px;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.5);
    }
    
    .segment {
      position: absolute;
      height: 100%;
      background: linear-gradient(to bottom, #4a9eff, #2563eb);
      opacity: 0.7;
      transition: opacity 0.2s;
      border-right: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
    }
    
    .segment:hover { opacity: 1; box-shadow: 0 0 10px rgba(74, 158, 255, 0.8); }
    
    #playhead {
      position: absolute;
      width: 3px;
      height: 100%;
      background: #ff4444;
      z-index: 10;
      pointer-events: none;
      box-shadow: 0 0 10px rgba(255, 68, 68, 0.8);
    }
    
    #playheadTime {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff4444;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    
    .time-tick {
      position: absolute;
      bottom: 5px;
      color: #FFF;
      font-size: 14px;
      /*  font-family: 'Courier New', monospace; */
      transform: translateX(-50%);
      user-select: none;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      align-items: center;
      justify-content: center;
    }
    
    .modal.active { display: flex; }
    
    .modal-content {
      background: #2a2a2a;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.8);
      border: 1px solid #444;
      max-width: 400px;
    }
    
    .modal-content h3 { margin-bottom: 15px; color: #4a9eff; }
    .modal-content button { margin-top: 20px; }
    
    .loading {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #4a9eff;
      font-size: 18px;
    }
    
    .loading.active { display: block; }
    
    .spinner {
      border: 4px solid rgba(74, 158, 255, 0.3);
      border-top: 4px solid #4a9eff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="controls">
    <select id="cameraSelect">
      <option>Select camera...</option>
    </select>
    <input type="date" id="datePicker">
    <input type="time" id="timePicker" step="1">
    <button onclick="jumpToTime()">‚è© Jump to time</button>
    <button id="downloadBtn" onclick="downloadVideo()" disabled>‚¨áÔ∏è Download</button>
    <div id="videoInfo"></div>
  </div>
  
  <div id="videoContainer">
    <video id="currentVideo" preload="auto"></video>
    <video id="nextVideo" preload="auto" style="display: none;"></video>
    
    <div id="playbackControls">
      <button class="control-btn" onclick="changeSpeed(-1)" title="Decrease speed">‚óÄ‚óÄ</button>
      <button class="control-btn" id="playPauseBtn" onclick="togglePlayPause()" title="Play/Pause">‚ñ∂</button>
      <button class="control-btn" onclick="changeSpeed(1)" title="Increase speed">‚ñ∂‚ñ∂</button>
      <span id="speedIndicator">1.0x</span>
    </div>
    
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div>Loading...</div>
    </div>
  </div>
  
  <div id="timeline">
    <div id="timelineWrapper">
      <div id="timelineBar">
        <div id="playhead">
          <div id="playheadTime">00:00:00</div>
        </div>
      </div>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <h3>Notice</h3>
      <p id="modalMessage"></p>
      <button onclick="closeModal()">OK</button>
    </div>
  </div>

  <script>
    // ============================================================================
    // STATE
    // ============================================================================
    const state = {
      videos: [],
      currentIndex: -1,
      speedIndex: 2, // 1.0x
      speeds: [0.25, 0.5, 1.0, 2.0, 4.0, 8.0, 16.0],
      zoom: 1,
      currentTime: 0,
      wasPlaying: false,
      refreshInterval: null
    };

    // ============================================================================
    // DOM ELEMENTS
    // ============================================================================
    const dom = {
      cameraSelect: document.getElementById('cameraSelect'),
      datePicker: document.getElementById('datePicker'),
      timePicker: document.getElementById('timePicker'),
      currentVideo: document.getElementById('currentVideo'),
      nextVideo: document.getElementById('nextVideo'),
      playPauseBtn: document.getElementById('playPauseBtn'),
      speedIndicator: document.getElementById('speedIndicator'),
      downloadBtn: document.getElementById('downloadBtn'),
      timelineBar: document.getElementById('timelineBar'),
      timelineWrapper: document.getElementById('timelineWrapper'),
      videoInfo: document.getElementById('videoInfo'),
      playhead: document.getElementById('playhead'),
      playheadTime: document.getElementById('playheadTime'),
      loading: document.getElementById('loading'),
      modal: document.getElementById('modal'),
      modalMessage: document.getElementById('modalMessage')
    };

    // ============================================================================
    // DATA LOADING
    // ============================================================================
    async function loadCameras() {
      try {
        const res = await fetch('/api/cameras');
        const cameras = await res.json();
        
        dom.cameraSelect.innerHTML = '<option value="">Select camera...</option>';
        cameras.forEach(c => {
          const option = document.createElement('option');
          option.value = c.id;
          option.textContent = c.name;
          dom.cameraSelect.appendChild(option);
        });
        
        if (cameras.length === 1) {
          dom.cameraSelect.value = cameras[0].id;
          loadVideos();
        }
      } catch (error) {
        console.error('Error loading cameras:', error);
        showModal('Failed to load cameras');
      }
    }

    async function loadVideos() {
      const camera = dom.cameraSelect.value;
      const date = dom.datePicker.value;
      if (!camera || !date) return;

      try {
        dom.loading.classList.add('active');
        
        const res = await fetch(`/api/videos/${camera}/${date}`);
        const newVideos = await res.json();
        
        dom.loading.classList.remove('active');

        if (newVideos.length === 0) {
          showModal('No videos available for this date/camera.');
          // Don't clear if we had videos before - keep showing previous date
          if (state.videos.length === 0) {
            dom.timelineBar.innerHTML = '<div id="playhead"><div id="playheadTime">00:00:00</div></div>';
          }
          return;
        }

        // Only update if changed
        if (JSON.stringify(state.videos) !== JSON.stringify(newVideos)) {
          state.videos = newVideos;
          renderTimeline();
          
          // Auto-play first video if nothing is playing
          if (state.currentIndex === -1) {
            state.wasPlaying = false;
            dom.playPauseBtn.textContent = '‚ñ∂';
            playVideo(0, true);
          }
        }
        
        startAutoRefresh();
      } catch (error) {
        console.error('Error loading videos:', error);
        dom.loading.classList.remove('active');
        showModal('Failed to load videos');
      }
    }

    function startAutoRefresh() {
      if (state.refreshInterval) clearInterval(state.refreshInterval);
      state.refreshInterval = setInterval(loadVideos, 30000); // 30 seconds
    }

    // ============================================================================
    // VIDEO PLAYBACK
    // ============================================================================
    function playVideo(index, shouldPlay = state.wasPlaying) {
      if (index < 0 || index >= state.videos.length) return;

      state.currentIndex = index;
      state.wasPlaying = shouldPlay;
      const v = state.videos[index];

      // Clean current video - force memory release
      dom.currentVideo.pause();
      dom.currentVideo.removeAttribute('src');
      dom.currentVideo.load();
      
      // Load new video
      dom.currentVideo.src = v.url;
      dom.currentVideo.playbackRate = state.speeds[state.speedIndex];
      
      if (shouldPlay) {
        dom.currentVideo.play().catch(e => console.error('Play error:', e));
        dom.playPauseBtn.textContent = '‚è∏';
      } else {
        dom.playPauseBtn.textContent = '‚ñ∂';
      }

      // Update UI
      dom.downloadBtn.disabled = false;
      dom.videoInfo.innerHTML = `<span>üìπ ${v.filename}</span><span>üìä ${(v.size / 1024 / 1024).toFixed(2)} MB</span>`;

      // Preload next
      preloadNext(index + 1);
      
      // Update playhead
      updatePlayhead();
    }

    function preloadNext(index) {
      if (index >= state.videos.length) return;
      
      // Clean previous preload to free memory
      dom.nextVideo.pause();
      dom.nextVideo.removeAttribute('src');
      dom.nextVideo.load();
      
      // Preload next
      dom.nextVideo.src = state.videos[index].url;
      dom.nextVideo.load();
    }

    function swapToNextVideo() {
      // Simply play the next video index
      const nextIndex = state.currentIndex + 1;
      if (nextIndex >= state.videos.length) {
        dom.currentVideo.pause();
        dom.playPauseBtn.textContent = '‚ñ∂';
        state.wasPlaying = false;
        return;
      }
      
      state.wasPlaying = true;
      playVideo(nextIndex, true);
    }

    function togglePlayPause() {
      if (dom.currentVideo.paused) {
        dom.currentVideo.play().catch(e => console.error('Play error:', e));
        dom.playPauseBtn.textContent = '‚è∏';
        state.wasPlaying = true;
      } else {
        dom.currentVideo.pause();
        dom.playPauseBtn.textContent = '‚ñ∂';
        state.wasPlaying = false;
      }
    }

    function changeSpeed(dir) {
      state.speedIndex = Math.max(0, Math.min(state.speeds.length - 1, state.speedIndex + dir));
      dom.currentVideo.playbackRate = state.speeds[state.speedIndex];
      dom.speedIndicator.textContent = `${state.speeds[state.speedIndex]}x`;
    }

    function downloadVideo() {
      if (state.currentIndex < 0) return;
      const v = state.videos[state.currentIndex];
      window.location.href = `${v.url}?download=true`;
    }

    function jumpToTime() {
      const time = dom.timePicker.value.split(':').map(Number);
      const targetSeconds = time[0] * 3600 + time[1] * 60 + (time[2] || 0);
      
      let closestIndex = 0;
      let minDiff = Infinity;
      
      state.videos.forEach((v, i) => {
        const d = new Date(v.timestamp);
        const videoSeconds = d.getHours() * 3600 + d.getMinutes() * 60 + d.getSeconds();
        const diff = Math.abs(videoSeconds - targetSeconds);
        if (diff < minDiff) {
          minDiff = diff;
          closestIndex = i;
        }
      });
      
      playVideo(closestIndex, state.wasPlaying);
    }

    // ============================================================================
    // TIMELINE
    // ============================================================================
    function renderTimeline() {
      // Clear and re-add playhead
      dom.timelineBar.innerHTML = '<div id="playhead"><div id="playheadTime">00:00:00</div></div>';
      
      state.videos.forEach((v, i) => {
        const d = new Date(v.timestamp);
        const minuteOfDay = d.getHours() * 60 + d.getMinutes() + d.getSeconds() / 60;
        const pos = (minuteOfDay / 1440) * 100 * state.zoom;
        const width = Math.max((v.duration / 60 / 1440) * 100 * state.zoom, 0.2);
        
        const seg = document.createElement('div');
        seg.className = 'segment';
        seg.style.left = `${pos}%`;
        seg.style.width = `${width}%`;
        seg.title = `${v.time} - ${v.filename}`;
        seg.onclick = (e) => {
          e.stopPropagation();
          playVideo(i, state.wasPlaying);
        };
        dom.timelineBar.appendChild(seg);
      });

      // Add time ticks every hour
      for (let hour = 0; hour <= 24; hour++) {
        const pos = (hour / 24) * 100 * state.zoom;
        const tick = document.createElement('div');
        tick.className = 'time-tick';
        tick.style.left = `${pos}%`;
        tick.textContent = `${hour.toString().padStart(2, '0')}:00`;
        dom.timelineBar.appendChild(tick);
      }

      dom.timelineBar.style.width = `${100 * state.zoom}%`;
      
      // Update references
      dom.playhead = document.getElementById('playhead');
      dom.playheadTime = document.getElementById('playheadTime');
    }

    function updatePlayhead() {
      if (state.currentIndex < 0) return;
      
      const v = state.videos[state.currentIndex];
      const d = new Date(v.timestamp);
      const startMinute = d.getHours() * 60 + d.getMinutes() + d.getSeconds() / 60;
      const currentMinute = startMinute + (state.currentTime / 60);
      const pos = (currentMinute / 1440) * 100 * state.zoom;
      
      dom.playhead.style.left = `${pos}%`;
      
      const currentD = new Date(v.timestamp);
      currentD.setSeconds(currentD.getSeconds() + Math.floor(state.currentTime));
      dom.playheadTime.textContent = currentD.toTimeString().slice(0, 8);

      // Smart auto-scroll: keep playhead centered
      const container = dom.timelineWrapper;
      const barWidth = dom.timelineBar.offsetWidth;
      const playheadPos = (pos / 100) * barWidth;
      const centerPos = container.scrollLeft + container.clientWidth / 2;
      
      // Only scroll if playhead is far from center
      if (Math.abs(playheadPos - centerPos) > container.clientWidth / 4) {
        const targetScroll = playheadPos - container.clientWidth / 2;
        container.scrollTo({ left: Math.max(0, targetScroll), behavior: 'smooth' });
      }
    }

    // ============================================================================
    // TIMELINE INTERACTIONS
    // ============================================================================
    let isDragging = false;
    let dragStartX, dragScrollLeft;
    let hasDragged = false;

    dom.timelineWrapper.addEventListener('mousedown', e => {
      isDragging = true;
      hasDragged = false;
      dom.timelineWrapper.classList.add('grabbing');
      dragStartX = e.pageX;
      dragScrollLeft = dom.timelineWrapper.scrollLeft;
    });

    dom.timelineWrapper.addEventListener('mouseleave', () => {
      isDragging = false;
      dom.timelineWrapper.classList.remove('grabbing');
    });

    dom.timelineWrapper.addEventListener('mouseup', e => {
      isDragging = false;
      dom.timelineWrapper.classList.remove('grabbing');
      
      // If no drag, treat as click to seek
      if (!hasDragged && e.target === dom.timelineBar) {
        const rect = dom.timelineBar.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const percent = x / rect.width;
        const minuteOfDay = (percent / state.zoom) * 1440;
        
        let closestIndex = 0;
        let minDiff = Infinity;
        
        state.videos.forEach((v, i) => {
          const d = new Date(v.timestamp);
          const videoMinute = d.getHours() * 60 + d.getMinutes() + d.getSeconds() / 60;
          const diff = Math.abs(videoMinute - minuteOfDay);
          if (diff < minDiff) {
            minDiff = diff;
            closestIndex = i;
          }
        });
        
        playVideo(closestIndex, state.wasPlaying);
      }
    });

    dom.timelineWrapper.addEventListener('mousemove', e => {
      if (!isDragging) return;
      e.preventDefault();
      
      const dragDistance = e.pageX - dragStartX;
      if (Math.abs(dragDistance) > 5) hasDragged = true;
      
      dom.timelineWrapper.scrollLeft = dragScrollLeft - dragDistance;
    });

    // Zoom with mouse wheel (no Ctrl needed)
    dom.timelineWrapper.addEventListener('wheel', e => {
      e.preventDefault();
      
      const oldZoom = state.zoom;
      state.zoom = Math.max(1, Math.min(10, state.zoom + (e.deltaY < 0 ? 0.5 : -0.5)));
      
      if (oldZoom !== state.zoom) {
        renderTimeline();
        
        // Maintain zoom center at cursor position
        const rect = dom.timelineWrapper.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const scrollRatio = (dom.timelineWrapper.scrollLeft + mouseX) / dom.timelineWrapper.scrollWidth;
        const newScroll = (dom.timelineWrapper.scrollWidth * scrollRatio) - mouseX;
        dom.timelineWrapper.scrollLeft = Math.max(0, newScroll);
      }
    }, { passive: false });

    // ============================================================================
    // KEYBOARD SHORTCUTS
    // ============================================================================
    document.addEventListener('keydown', e => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
      
      switch(e.key) {
        case ' ':
          e.preventDefault();
          togglePlayPause();
          break;
        case 'ArrowLeft':
          dom.currentVideo.currentTime = Math.max(0, dom.currentVideo.currentTime - 5);
          break;
        case 'ArrowRight':
          dom.currentVideo.currentTime = Math.min(dom.currentVideo.duration, dom.currentVideo.currentTime + 5);
          break;
        case 'ArrowUp':
          changeSpeed(1);
          break;
        case 'ArrowDown':
          changeSpeed(-1);
          break;
        case 'd':
        case 'D':
          downloadVideo();
          break;
      }
    });

    // ============================================================================
    // UI HELPERS
    // ============================================================================
    function showModal(msg) {
      dom.modalMessage.textContent = msg;
      dom.modal.classList.add('active');
    }

    function closeModal() {
      dom.modal.classList.remove('active');
    }

    // ============================================================================
    // VIDEO EVENTS
    // ============================================================================
    dom.currentVideo.addEventListener('ended', swapToNextVideo);
    dom.currentVideo.addEventListener('timeupdate', () => {
      state.currentTime = dom.currentVideo.currentTime;
      updatePlayhead();
    });
    dom.currentVideo.addEventListener('loadstart', () => dom.loading.classList.add('active'));
    dom.currentVideo.addEventListener('canplay', () => dom.loading.classList.remove('active'));
    dom.currentVideo.addEventListener('play', () => {
      dom.playPauseBtn.textContent = '‚è∏';
      state.wasPlaying = true;
    });
    dom.currentVideo.addEventListener('pause', () => {
      dom.playPauseBtn.textContent = '‚ñ∂';
      state.wasPlaying = false;
    });

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    (async () => {
      const today = new Date();
      dom.datePicker.value = today.toISOString().split('T')[0];
      dom.timePicker.value = today.toTimeString().slice(0, 8);
      
      await loadCameras();
      
      dom.cameraSelect.addEventListener('change', () => {
        state.currentIndex = -1;
        state.wasPlaying = false;
        dom.currentVideo.pause();
        dom.currentVideo.removeAttribute('src');
        dom.currentVideo.load();
        dom.playPauseBtn.textContent = '‚ñ∂';
        loadVideos();
      });
      
      dom.datePicker.addEventListener('change', () => {
        state.currentIndex = -1;
        state.wasPlaying = false;
        dom.currentVideo.pause();
        dom.currentVideo.removeAttribute('src');
        dom.currentVideo.load();
        dom.playPauseBtn.textContent = '‚ñ∂';
        loadVideos();
      });
      
      // Close modal on outside click
      dom.modal.addEventListener('click', e => {
        if (e.target === dom.modal) closeModal();
      });
    })();
  </script>
</body>
</html>
